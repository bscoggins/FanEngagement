name: Blockchain Adapters CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'adapters/**'
      - '.github/workflows/blockchain-adapters.yml'
  pull_request:
    paths:
      - 'adapters/**'
      - '.github/workflows/blockchain-adapters.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/fanengagement

jobs:
  build-solana-adapter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Solana adapter image
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/solana
          file: ./adapters/solana/Dockerfile
          load: true
          tags: solana-adapter:test
          target: test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run unit tests
        run: |
          echo "Tests already run during Docker build (test stage)"
          docker images solana-adapter:test
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'solana-adapter:test'
          format: 'sarif'
          output: 'trivy-solana-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-solana-results.sarif'
      
      - name: Fail on HIGH or CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'solana-adapter:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os'
      
      - name: Test health endpoint
        # TODO: Enable once test Solana keypairs are available in GitHub Secrets.
        # The adapter requires a valid Solana keypair to start.
        # Before enabling, add SOLANA_TEST_PRIVATE_KEY to repository secrets.
        if: false
        run: |
          # Build production image for health check testing
          docker build --target production -t solana-adapter:prod ./adapters/solana
          
          # Run health check validation using test key from GitHub Secrets
          docker run -d --name adapter-test \
            -p 3001:3001 \
            -e NODE_ENV=production \
            -e SOLANA_RPC_URL=https://api.devnet.solana.com \
            -e SOLANA_PRIVATE_KEY='${{ secrets.SOLANA_TEST_PRIVATE_KEY }}' \
            solana-adapter:prod
          
          # Wait for container to be ready
          echo "Waiting for container to be ready..."
          sleep 15
          
          # Test health endpoint
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3001/v1/adapter/health; then
              echo "Health check passed!"
              docker stop adapter-test
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs adapter-test
          docker stop adapter-test
          exit 1
      
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate image tags
        if: github.event_name != 'pull_request'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}-solana-adapter
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Solana adapter
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/solana
          file: ./adapters/solana/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production

  build-polygon-adapter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Polygon adapter image
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/polygon
          file: ./adapters/polygon/Dockerfile
          load: true
          tags: polygon-adapter:test
          target: test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run unit tests
        run: |
          echo "Tests already run during Docker build (test stage)"
          docker images polygon-adapter:test
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'polygon-adapter:test'
          format: 'sarif'
          output: 'trivy-polygon-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-polygon-results.sarif'
      
      - name: Fail on HIGH or CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'polygon-adapter:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os'
      
      - name: Test health endpoint
        # TODO: Enable once test Polygon private keys are available in GitHub Secrets.
        # Before enabling, add POLYGON_TEST_PRIVATE_KEY to repository GitHub Secrets.
        # The adapter requires a valid private key to start
        if: false
        run: |
          # Build production image for health check testing
          docker build --target production -t polygon-adapter:prod ./adapters/polygon
          
          # Start container with test private key for health check validation
          docker run -d --name adapter-test \
            -p 3002:3002 \
            -e NODE_ENV=production \
            -e POLYGON_RPC_URL=https://rpc-mumbai.maticvigil.com \
            -e POLYGON_PRIVATE_KEY='${{ secrets.POLYGON_TEST_PRIVATE_KEY }}' \
            polygon-adapter:prod
          
          # Wait for container to be ready
          echo "Waiting for container to be ready..."
          sleep 15
          
          # Test health endpoint
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3002/v1/adapter/health; then
              echo "Health check passed!"
              docker stop adapter-test
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs adapter-test
          docker stop adapter-test
          exit 1
      
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate image tags
        if: github.event_name != 'pull_request'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}-polygon-adapter
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Polygon adapter
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/polygon
          file: ./adapters/polygon/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          target: production
