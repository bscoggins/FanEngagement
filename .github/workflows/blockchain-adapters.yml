name: Blockchain Adapters CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'adapters/**'
      - '.github/workflows/blockchain-adapters.yml'
  pull_request:
    paths:
      - 'adapters/**'
      - '.github/workflows/blockchain-adapters.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/fanengagement

jobs:
  build-solana-adapter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Solana adapter image
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/solana
          file: ./adapters/solana/Dockerfile
          load: true
          tags: solana-adapter:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run unit tests
        run: |
          docker run --rm \
            -e NODE_ENV=test \
            --entrypoint sh \
            solana-adapter:test \
            -c "npm ci && npm test"
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'solana-adapter:test'
          format: 'sarif'
          output: 'trivy-solana-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-solana-results.sarif'
      
      - name: Fail on HIGH or CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'solana-adapter:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      - name: Test health endpoint
        run: |
          # Generate a temporary keypair for testing
          docker run -d --name adapter-test \
            -p 3001:3001 \
            -e NODE_ENV=production \
            -e SOLANA_RPC_URL=https://api.devnet.solana.com \
            -e SOLANA_PRIVATE_KEY='[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64]' \
            solana-adapter:test
          
          # Wait for container to be ready
          echo "Waiting for container to be ready..."
          sleep 15
          
          # Test health endpoint
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3001/v1/adapter/health; then
              echo "Health check passed!"
              docker stop adapter-test
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs adapter-test
          docker stop adapter-test
          exit 1
      
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate image tags
        if: github.event_name != 'pull_request'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}-solana-adapter
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Solana adapter
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/solana
          file: ./adapters/solana/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-solana-adapter:latest
            ${{ env.IMAGE_PREFIX }}-solana-adapter:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-polygon-adapter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Polygon adapter image
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/polygon
          file: ./adapters/polygon/Dockerfile
          load: true
          tags: polygon-adapter:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run unit tests
        run: |
          docker run --rm \
            -e NODE_ENV=test \
            --entrypoint sh \
            polygon-adapter:test \
            -c "npm ci && npm test"
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'polygon-adapter:test'
          format: 'sarif'
          output: 'trivy-polygon-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-polygon-results.sarif'
      
      - name: Fail on HIGH or CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'polygon-adapter:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      
      - name: Test health endpoint
        run: |
          # Start container with test private key
          docker run -d --name adapter-test \
            -p 3002:3002 \
            -e NODE_ENV=production \
            -e POLYGON_RPC_URL=https://rpc-mumbai.maticvigil.com \
            -e POLYGON_PRIVATE_KEY='0x0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef' \
            polygon-adapter:test
          
          # Wait for container to be ready
          echo "Waiting for container to be ready..."
          sleep 15
          
          # Test health endpoint
          max_attempts=10
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:3002/v1/adapter/health; then
              echo "Health check passed!"
              docker stop adapter-test
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs adapter-test
          docker stop adapter-test
          exit 1
      
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate image tags
        if: github.event_name != 'pull_request'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}-polygon-adapter
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      
      - name: Build and push Polygon adapter
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: ./adapters/polygon
          file: ./adapters/polygon/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-polygon-adapter:latest
            ${{ env.IMAGE_PREFIX }}-polygon-adapter:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
