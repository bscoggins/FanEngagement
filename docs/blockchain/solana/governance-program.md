# Solana Governance Program

This guide explains how to build, test, and run the fan-governance Solana program locally, plus a concise architecture overview.

## Purpose and scope

The governance application records organization governance decisions on-chain for transparency and auditability. It provides:

- **Organizations**: authority-managed PDAs for isolating proposals per org
- **Proposals**: lifecycle (`Draft → Open → Closed → Finalized`) with timing, quorum, and voting power metadata
- **Results commitments**: immutable results hash, winning option, quorum flag, and timestamps stored on-chain for independent verification
- **Finalization**: authoritative lock that marks results as executed/consumed by off-chain services

## Prerequisites

- Rust toolchain (via `rustup`)
- Solana CLI (>= 3.0.x) on PATH (`~/.local/share/solana/install/active_release/bin`)
- Anchor CLI 0.32.x on PATH (`~/.cargo/bin`)
- Node.js + pnpm if you plan to drive Anchor tests (not required for Rust unit tests)
- Git submodules and workspace dependencies fetched (run from repo root):
  - `pnpm install` for JS adapters if needed
  - `rustup target add sbpf-solana-solana` is handled by Anchor install, but you can re-run if required

## Directory layout

- Program sources: `adapters/solana/program/programs/fan-governance/src`
- Cargo workspace for program: `adapters/solana/program`
- Tests: `adapters/solana/program/programs/fan-governance/tests`
- IDL output: `adapters/solana/program/target/idl/fan_governance.json` (generated by `anchor build`)
- Keypair/IDs: `adapters/solana/program/Anchor.toml` and `programs/fan-governance/src/lib.rs` (declare_id)

## Architecture summary

- Program ID: `53kLd3Zo8gqPyHuuALc1fLoARPszVkheA4P859MtfPo`
- Core accounts:
  - `OrganizationAccount`: stores organization id, name, authority, proposal_count, timestamps, bump.
  - `ProposalAccount`: stores proposal metadata, lifecycle status (`Draft|Open|Closed|Finalized`), timing, quorum requirement, eligible voting power, creator, bumps.
  - `ProposalResultsAccount`: stores committed vote results hash, winning option, quorum flag, timestamps, bump.
- PDA seeds:
  - Organization: `b"organization"`, `organization_id` (16 bytes)
  - Proposal: `b"proposal"`, `organization_pda`, `proposal_id` (16 bytes)
  - Proposal results: `b"proposal_results"`, `proposal_pda`
- Instructions:
  - `create_organization`: creates organization PDA, sets authority and metadata.
  - `create_proposal`: creates proposal PDA scoped to organization; enforces authority and basic validation.
  - `update_proposal_status`: moves proposal through lifecycle with validation.
  - `commit_vote_results`: writes cryptographic results commitment for a closed proposal.
  - `finalize_proposal`: marks proposal as finalized and records results finalization time.

## Build and test locally

From the repo root:

```bash
# Ensure toolchains are on PATH for this shell
source "$HOME/.cargo/env"
export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

# Build the program and emit IDL
author_env="adapters/solana/program"
cd "$author_env"
anchor build

# Run Rust unit tests for the program
cargo test -p fan-governance

# Or run the combined build + test + validator install check helper
./scripts/run-solana-governance-tests.sh
```

If program IDs ever drift from the keypair, resync:

```bash
cd adapters/solana/program
anchor keys sync
```

## What the tests cover

- PDA derivations for organization, proposal, and proposal_results seeds
- Account sizing and constant bounds (name/title lengths, quorum max, status discriminants)
- **End-to-end governance flow (ProgramTest, BPF)**: create organization → create proposal → open → close → commit results → finalize; uses `BPF_OUT_DIR=../../target/deploy` to load the compiled `.so`
- Validator install sanity (solana-test-validator via `scripts/run-solana-governance-validator.sh`) ensuring the program account is executable
- **Live docker validator flow**: `scripts/run-solana-governance-tests.sh` now spins up `solana-test-validator` via Docker, deploys the compiled BPF over RPC, and runs `live_validator_flow` against that validator to confirm on-chain writes end-to-end. Set `RUN_LIVE_VALIDATOR_TEST=1` manually if invoking the test outside the script.

## Common issues and fixes

- **Program ID mismatch**: run `anchor keys sync` then rebuild.
- **Missing solana_program crate**: ensure `solana-program` dependency is present in the program Cargo.toml (currently wired via workspace) and that `anchor_lang::solana_program` is in scope if needed.
- **Toolchain on PATH**: re-source `~/.cargo/env` and prepend the Solana CLI path for the shell executing builds/tests.

## Next steps

- Extend validator tests to exercise instruction flows (create_organization, create_proposal, finalize) using Anchor CPI helpers.
- Publish the generated IDL to your consumer services after `anchor build` when ready.
