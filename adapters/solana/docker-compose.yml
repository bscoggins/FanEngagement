services:
  solana-test-validator:
    image: solanalabs/solana:v1.18.26
    platform: linux/amd64
    container_name: solana-test-validator
    command: solana-test-validator --no-bpf-jit --reset --rpc-port 8899
    ports:
      - "8899:8899"
    healthcheck:
      test: ["CMD", "solana", "cluster-version", "--url", "http://localhost:8899"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - solana-adapter-network

  solana-adapter:
    platform: linux/amd64
    build:
      context: ../..
      dockerfile: adapters/solana/Dockerfile
    container_name: solana-adapter
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - LOG_LEVEL=debug
      - SOLANA_NETWORK=localnet
      - SOLANA_RPC_URL=http://solana-test-validator:8899
      - SOLANA_COMMITMENT=confirmed
      - SOLANA_CONFIRM_TIMEOUT=30000
      # IMPORTANT: You must provide a valid Solana keypair for SOLANA_PRIVATE_KEY.
      # Generate one with: solana-keygen new --outfile keypair.json
      # Then set: SOLANA_PRIVATE_KEY=$(cat keypair.json)
      - SOLANA_PRIVATE_KEY=${SOLANA_PRIVATE_KEY}
      - API_KEY=${API_KEY:-dev-api-key-change-in-production}
      - REQUIRE_AUTH=true
      - RETRY_MAX_ATTEMPTS=4
      - RETRY_BASE_DELAY_MS=1000
    depends_on:
      solana-test-validator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/v1/adapter/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - solana-adapter-network

networks:
  solana-adapter-network:
    driver: bridge
