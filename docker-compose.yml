services:
  db:
    image: postgres:16
    container_name: fanengagement-db
    environment:
      POSTGRES_USER: fanengagement
      POSTGRES_PASSWORD: fanengagement
      POSTGRES_DB: fanengagement
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fanengagement"]
      interval: 5s
      timeout: 5s
      retries: 10
  api:
    build:
      context: .
      dockerfile: backend/FanEngagement.Api/Dockerfile
    container_name: fanengagement-api
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: Host=db;Port=5432;Database=fanengagement;Username=fanengagement;Password=fanengagement
      # JWT configuration (override via .env or CI secrets)
      # BREAKING CHANGE: You must set JWT_SIGNING_KEY in your environment or .env.development file.
      # The API will fail to start if this variable is not set.
      Jwt__Issuer: FanEngagement
      Jwt__Audience: FanEngagement
      Jwt__SigningKey: ${JWT_SIGNING_KEY:-dev-signing-key-change-in-production}
      # Blockchain Adapter Configuration
      BlockchainAdapters__Solana__BaseUrl: http://solana-adapter:3001/v1/adapter/
      BlockchainAdapters__Solana__ApiKey: ${API_KEY:-dev-api-key-change-in-production}
      BlockchainAdapters__Polygon__BaseUrl: http://polygon-adapter:3002/v1/adapter/
      BlockchainAdapters__Polygon__ApiKey: ${API_KEY:-dev-api-key-change-in-production}
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: /api
    container_name: fanengagement-frontend
    ports:
      - "3000:80"
    depends_on:
      - api
  solana-adapter:
    build:
      context: .
      dockerfile: adapters/solana/Dockerfile
    container_name: solana-adapter
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: development
      PORT: 3001
      LOG_LEVEL: debug
      SOLANA_NETWORK: devnet
      SOLANA_RPC_URL: https://api.devnet.solana.com
      SOLANA_COMMITMENT: confirmed
      SOLANA_CONFIRM_TIMEOUT: 30000
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY}
      SOLANA_PROGRAM_ID: MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr
      API_KEY: ${API_KEY:-dev-api-key-change-in-production}
      REQUIRE_AUTH: "true"
      RETRY_MAX_ATTEMPTS: 4
      RETRY_BASE_DELAY_MS: 1000
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/v1/adapter/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
  polygon-adapter:
    build:
      context: .
      dockerfile: adapters/polygon/Dockerfile
    container_name: polygon-adapter
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: development
      PORT: 3002
      LOG_LEVEL: debug
      POLYGON_NETWORK: amoy
      POLYGON_RPC_URL: https://rpc-amoy.polygon.technology
      POLYGON_CONFIRMATIONS: 6
      POLYGON_TX_TIMEOUT: 120000
      POLYGON_PRIVATE_KEY: ${POLYGON_PRIVATE_KEY:-dev-key-change-in-production}
      API_KEY: ${API_KEY:-dev-api-key-change-in-production}
      REQUIRE_AUTH: "true"
      RETRY_MAX_ATTEMPTS: 4
      RETRY_BASE_DELAY_MS: 1000
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/v1/adapter/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
  tests:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    working_dir: /src/backend
    volumes:
      - ./:/src
    profiles: ["tests"]
    depends_on:
      db:
        condition: service_healthy
    environment:
      ConnectionStrings__DefaultConnection: Host=db;Port=5432;Database=fanengagement;Username=fanengagement;Password=fanengagement
    command: ["dotnet", "test"]
  e2e:
    image: mcr.microsoft.com/playwright:v1.56.1-jammy
    container_name: fanengagement-e2e
    working_dir: /workspace/frontend
    command: ["sh", "-c", "npm ci && npm run e2e"]
    profiles: ["e2e"]
    environment:
      CI: "1"
      E2E_BASE_URL: http://frontend
      VITE_API_BASE_URL: http://api:8080
    depends_on:
      - frontend
    volumes:
      - ./frontend:/workspace/frontend
      - playwright-cache:/root/.cache/ms-playwright
      - frontend-node_modules:/workspace/frontend/node_modules

  playwright-mcp:
    image: mcr.microsoft.com/playwright:v1.56.1-jammy
    container_name: fanengagement-playwright-mcp
    working_dir: /workspace
    profiles: ["tools"]
    command: >
      sh -c "
      npm init -y >/dev/null 2>&1 || true &&
      npm install @playwright/mcp@latest --no-audit --no-fund --silent &&
      npx playwright install-deps &&
      npx playwright install chromium &&
      echo 'Playwright MCP ready. Keeping container alive...' &&
      tail -f /dev/null
      "
    environment:
      PLAYWRIGHT_MCP_BASE_URL: http://frontend
    depends_on:
      - frontend
    volumes:
      - ./frontend:/workspace/frontend:ro
      - playwright-cache:/root/.cache/ms-playwright

volumes:
  db_data:
  solana_data:
  playwright-cache:
  frontend-node_modules:
